% Power System Oscillation Simulation - Interharmonics causing beating pattern
% Based on equation (2.1) from the paper

clear; clc; close all;

%% Parameter Selection (Realistic Values)
% Fundamental frequency
f1 = 60;           % Hz (North American grid frequency)
omega1 = 2*pi*f1;  % rad/s

% Oscillation parameters
fos = 3;           % Oscillation frequency in Hz (typical for power system oscillations: 0.1-3 Hz)
omega_os = 2*pi*fos;

% Voltage parameters
V1 = 120;          % RMS voltage (120V typical residential)
V1_peak = V1 * sqrt(2);  % Peak voltage for time domain
m = 0.1;           % Oscillation magnitude (10% - realistic for power systems)

% Time parameters
duration = 3;      % seconds (need several oscillation cycles to see beating)
fs = 5000;         % sampling frequency (Hz) - high enough to capture interharmonics
t = 0:1/fs:duration;

%% Calculate interharmonic frequencies
f_upper = f1 + fos;  % Upper interharmonic: 63 Hz
f_lower = f1 - fos;  % Lower interharmonic: 57 Hz

fprintf('Fundamental frequency: %.1f Hz\n', f1);
fprintf('Oscillation frequency: %.1f Hz\n', fos);
fprintf('Upper interharmonic: %.1f Hz\n', f_upper);
fprintf('Lower interharmonic: %.1f Hz\n', f_lower);

%% Generate the complete waveform using equation
% v(t) = 2*V1*cos(ω1*t) + (m*V1/2)*{cos[(ω1 + ωos)*t] + cos[(ω1 - ωos)*t]}

v_fundamental = V1_peak * cos(omega1 * t);
v_upper_ih = (m * V1_peak / 2) * cos((omega1 + omega_os) * t);
%v_upper_ih = 0; 
v_lower_ih = (m * V1_peak / 2) * cos((omega1 - omega_os) * t);
%v_lower_ih = 0;  
v_total = v_fundamental + v_upper_ih + v_lower_ih;

%% Calculate envelope for visualization (beating pattern)
% The envelope oscillates at the difference frequency
% envelope_upper = V1_peak * (1 + m/2 * cos(omega_os * t));
% envelope_lower = -V1_peak * (1 + m/2 * cos(omega_os * t));

[envelope_upper, envelope_lower] = envelope(v_total);

%% Calculate phasor magnitude (what PMU would measure)
% Using sliding window RMS calculation
window_samples = round(fs/f1);  % One fundamental cycle
phasor_mag = zeros(size(t));
for i = window_samples:length(t)
    window_data = v_total(i-window_samples+1:i);
    phasor_mag(i) = sqrt(mean(window_data.^2));
end

%% Plotting
figure('Position', [100 100 1200 800]);

% Subplot 1: Complete waveform with envelope
subplot(3,1,1);
plot(t, v_total, 'b-', 'LineWidth', 1);
hold on;
plot(t, envelope_upper, 'r--', 'LineWidth', 2);
plot(t, envelope_lower, 'r--', 'LineWidth', 2);
grid on;
xlabel('Time (s)');
ylabel('Voltage (V)');
title('Complete Voltage Waveform Showing Beating Pattern');
legend('Total Waveform', 'Envelope (Beating Pattern)', 'Location', 'northeast');
xlim([0 duration]);

% Subplot 2: Individual components
subplot(3,1,2);
plot(t, v_fundamental, 'g-', 'LineWidth', 1.5);
hold on;
plot(t, v_upper_ih*10, 'r-', 'LineWidth', 1); % Scaled up for visibility
plot(t, v_lower_ih*10, 'm-', 'LineWidth', 1); % Scaled up for visibility
grid on;
xlabel('Time (s)');
ylabel('Voltage (V)');
title('Individual Components (Interharmonics scaled 10x for visibility)');
legend('60 Hz Fundamental', '63 Hz Interharmonic (×10)', '57 Hz Interharmonic (×10)', 'Location', 'northeast');
xlim([0 duration]);

% Subplot 3: Phasor magnitude (what oscillation detection sees)
subplot(3,1,3);
plot(t, phasor_mag, 'k-', 'LineWidth', 2);
hold on;
plot(t, V1 * ones(size(t)), 'g--', 'LineWidth', 1);
grid on;
xlabel('Time (s)');
ylabel('RMS Voltage (V)');
title('Phasor Magnitude (PMU Measurement) - Shows Oscillation');
legend('Measured Phasor RMS', 'Expected Steady Value', 'Location', 'northeast');
xlim([0 duration]);

%% Frequency domain analysis
figure('Position', [100 100 800 600]);
N = length(v_total);
f_axis = (0:N-1) * fs / N;
V_fft = abs(fft(v_total))/ N * 2;  % Two-sided to one-sided conversion

% Plot spectrum
semilogy(f_axis(1:N/2), V_fft(1:N/2), 'b-', 'LineWidth', 1.5);
hold on;
% Mark the key frequencies
plot(f1, V_fft(round(f1*N/fs)), 'ro', 'MarkerSize', 8, 'MarkerFaceColor', 'r');
plot(f_upper, V_fft(round(f_upper*N/fs)), 'go', 'MarkerSize', 8, 'MarkerFaceColor', 'g');
plot(f_lower, V_fft(round(f_lower*N/fs)), 'mo', 'MarkerSize', 8, 'MarkerFaceColor', 'm');

grid on;
xlabel('Frequency (Hz)');
ylabel('Magnitude (V)');
title('Frequency Spectrum - Shows Fundamental and Interharmonics');
legend('Spectrum', '60 Hz', '63 Hz', '57 Hz', 'Location', 'northeast');
xlim([50 70]);
ylim([1e-3 200]);

%% Display key results
fprintf('\nKey Results:\n');
fprintf('Peak oscillation in phasor magnitude: %.2f%%\n', (max(phasor_mag)-min(phasor_mag))/V1*100);
fprintf('Expected oscillation magnitude: %.2f%%\n', m*100);
fprintf('Beating period: %.2f seconds\n', 1/fos);

%% 